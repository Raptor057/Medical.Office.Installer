#!/bin/bash
set -e

# Obtener el path del script
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# ğŸ” Cargar variables desde .env o .env.gpg
if [[ -f "$PROJECT_ROOT/.env" ]]; then
  echo "ğŸ” Cargando variables desde .env"
  set -a
  source "$PROJECT_ROOT/.env"
  set +a
elif [[ -f "$PROJECT_ROOT/.env.gpg" ]]; then
  echo "ğŸ” Desencriptando .env.gpg..."
  gpg --quiet --batch --yes --decrypt \
      --passphrase="$MY_ENV_PASSPHRASE" \
      --output "$PROJECT_ROOT/.env" "$PROJECT_ROOT/.env.gpg"

  echo "ğŸ” Cargando variables desencriptadas"
  set -a
  source "$PROJECT_ROOT/.env"
  set +a
else
  echo "âŒ No se encontrÃ³ ni .env ni .env.gpg"
  exit 1
fi

# âœ… Verificar Docker segÃºn el sistema operativo
if [[ "$OSTYPE" == "darwin"* ]]; then
  bash "$PROJECT_ROOT/scripts/check_docker_macos.sh"
else
  bash "$PROJECT_ROOT/scripts/check_docker_linux.sh"
fi

# ğŸ”‘ Login a GHCR
echo "$GHCR_PAT" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin

# ğŸš€ Actualizar e iniciar contenedores
echo "ğŸ” Verificando actualizaciones de imÃ¡genes..."
docker-compose -f "$PROJECT_ROOT/docker-compose.yml" pull

echo "â¬ Apagando contenedores anteriores (si existen)..."
docker-compose -f "$PROJECT_ROOT/docker-compose.yml" down

echo "ğŸš€ Iniciando contenedores..."
docker-compose -f "$PROJECT_ROOT/docker-compose.yml" up -d
